<!-- Page Header -->
<c-row class="mb-4">
  <c-col>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-1">
          <svg
            cIcon
            name="cilCalendar"
            class="me-2"
            style="color: #667eea"
          ></svg>
          Attendance Report
        </h2>
        <p class="text-body-secondary mb-0">
          <svg cIcon name="cilInfo" size="sm" class="me-1"></svg>
          Track and manage member attendance
        </p>
      </div>
    </div>
  </c-col>
</c-row>

<!-- Stats Cards -->
<c-row class="mb-4">
  <c-col xs="12" md="6" lg="3">
    <c-card class="stats-card">
      <c-card-body>
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-primary-subtle">
            <svg cIcon name="cilPeople" style="color: #667eea"></svg>
          </div>
          <div class="ms-3">
            <div class="stats-value">{{ totalAttendances() }}</div>
            <div class="stats-label">Total Records</div>
          </div>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
  <c-col xs="12" md="6" lg="3">
    <c-card class="stats-card">
      <c-card-body>
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-success-subtle">
            <svg cIcon name="cilCheckCircle" style="color: #10b981"></svg>
          </div>
          <div class="ms-3">
            <div class="stats-value">{{ getTodayAttendanceCount() }}</div>
            <div class="stats-label">Today's Attendance</div>
          </div>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
  <c-col xs="12" md="6" lg="3">
    <c-card class="stats-card">
      <c-card-body>
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-warning-subtle">
            <svg cIcon name="cilClock" style="color: #f59e0b"></svg>
          </div>
          <div class="ms-3">
            <div class="stats-value">{{ getActiveSessionsCount() }}</div>
            <div class="stats-label">Active Sessions</div>
          </div>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
  <c-col xs="12" md="6" lg="3">
    <c-card class="stats-card">
      <c-card-body>
        <div class="d-flex align-items-center">
          <div class="stats-icon bg-info-subtle">
            <svg cIcon name="cilChart" style="color: #3b82f6"></svg>
          </div>
          <div class="ms-3">
            <div class="stats-value">{{ getCompletedSessionsCount() }}</div>
            <div class="stats-label">Completed Today</div>
          </div>
        </div>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Average Duration Card -->
<c-row class="mb-4">
  <c-col xs="12">
    <c-card class="duration-card">
      <c-card-body>
        <c-row class="align-items-center">
          <c-col xs="12" md="3">
            <div class="d-flex align-items-center">
              <div class="duration-icon">
                <svg cIcon name="cilTimer" size="3xl"></svg>
              </div>
              <div class="ms-3">
                <div class="duration-label">Average Session Duration</div>
                <div class="duration-value">{{ getAverageDuration() }}</div>
              </div>
            </div>
          </c-col>
          <c-col xs="12" md="9" class="mt-3 mt-md-0">
            <div class="duration-stats">
              <div class="duration-stat-item">
                <div class="stat-icon bg-success-subtle">
                  <svg cIcon name="cilArrowTop" style="color: #10b981"></svg>
                </div>
                <div class="ms-2">
                  <div class="stat-label">Longest Session</div>
                  <div class="stat-value">{{ getLongestSession() }}</div>
                </div>
              </div>
              <div class="duration-stat-item">
                <div class="stat-icon bg-info-subtle">
                  <svg cIcon name="cilArrowBottom" style="color: #3b82f6"></svg>
                </div>
                <div class="ms-2">
                  <div class="stat-label">Shortest Session</div>
                  <div class="stat-value">{{ getShortestSession() }}</div>
                </div>
              </div>
              <div class="duration-stat-item">
                <div class="stat-icon bg-warning-subtle">
                  <svg cIcon name="cilMediaPlay" style="color: #f59e0b"></svg>
                </div>
                <div class="ms-2">
                  <div class="stat-label">Active Now</div>
                  <div class="stat-value">
                    {{ getActiveSessionsCount() }} members
                  </div>
                </div>
              </div>
            </div>
          </c-col>
        </c-row>
      </c-card-body>
    </c-card>
  </c-col>
</c-row>

<!-- Loading State -->
@if (loading() && attendances().length === 0) {
  <c-row>
    <c-col xs="12" class="text-center py-5">
      <c-spinner color="primary"></c-spinner>
      <p class="mt-3 text-body-secondary">Loading attendance records...</p>
    </c-col>
  </c-row>
}

<!-- Error State -->
@if (error() && attendances().length === 0) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    </c-col>
  </c-row>
}

@if (!loading() || attendances().length > 0) {
  <!-- Search and Filters -->
  <c-row class="mb-4">
    <c-col xs="12" md="4">
      <div class="search-box">
        <svg cIcon name="cilSearch"></svg>
        <input
          cFormControl
          type="text"
          placeholder="Search by name, phone, or member code..."
          [(ngModel)]="searchTerm"
          (ngModelChange)="onSearchChange()"
        />
      </div>
    </c-col>
    <c-col xs="12" md="3">
      <input
        cFormControl
        type="date"
        placeholder="Start Date"
        [(ngModel)]="startDate"
        (ngModelChange)="onDateFilterChange()"
      />
    </c-col>
    <c-col xs="12" md="3">
      <input
        cFormControl
        type="date"
        placeholder="End Date"
        [(ngModel)]="endDate"
        (ngModelChange)="onDateFilterChange()"
      />
    </c-col>
    <c-col xs="12" md="2">
      <button
        cButton
        color="light"
        class="w-100"
        (click)="clearFilters()"
        [disabled]="loading()"
      >
        <svg cIcon name="cilFilterX" class="me-2"></svg>
        Clear
      </button>
    </c-col>
  </c-row>

  <!-- Attendance Table -->
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="p-0">
          <table cTable [hover]="true" class="mb-0">
            <thead>
              <tr>
                <th scope="col">Member</th>
                <th scope="col">Member Code</th>
                <th scope="col">Check-In</th>
                <th scope="col">Check-Out</th>
                <th scope="col">Duration</th>
                <th scope="col">Status</th>
                <th scope="col">Notes</th>
              </tr>
            </thead>
            <tbody>
              @for (attendance of filteredAttendances; track attendance._id) {
                <tr>
                  <td>
                    <div>
                      <div class="fw-bold">
                        {{ attendance.profile.fullName }}
                      </div>
                      <div class="small text-body-secondary">
                        {{ attendance.user.phoneNumber }}
                      </div>
                    </div>
                  </td>
                  <td>
                    <span class="member-code">{{
                      attendance.member.memberCode
                    }}</span>
                    <div class="mt-1">
                      <c-badge
                        [color]="getMemberStatusColor(attendance.member.status)"
                        size="sm"
                      >
                        {{ attendance.member.status }}
                      </c-badge>
                    </div>
                  </td>
                  <td>
                    <div class="time-info">
                      <svg cIcon name="cilClock" size="sm" class="me-1"></svg>
                      {{ attendance.checkInTime | date: "MMM d, yyyy" }}
                      <div class="small text-body-secondary">
                        {{ attendance.checkInTime | date: "h:mm a" }}
                      </div>
                    </div>
                  </td>
                  <td>
                    @if (attendance.checkOutTime) {
                      <div class="time-info">
                        <svg cIcon name="cilClock" size="sm" class="me-1"></svg>
                        {{ attendance.checkOutTime | date: "MMM d, yyyy" }}
                        <div class="small text-body-secondary">
                          {{ attendance.checkOutTime | date: "h:mm a" }}
                        </div>
                      </div>
                    } @else {
                      <c-badge color="warning">Active</c-badge>
                    }
                  </td>
                  <td>
                    <span class="duration-badge">
                      {{
                        calculateDuration(
                          attendance.checkInTime,
                          attendance.checkOutTime
                        )
                      }}
                    </span>
                  </td>
                  <td>
                    <c-badge [color]="getStatusBadge(attendance).color">
                      {{ getStatusBadge(attendance).text }}
                    </c-badge>
                  </td>
                  <td>
                    @if (attendance.notes) {
                      <span class="text-body-secondary small">{{
                        attendance.notes
                      }}</span>
                    } @else {
                      <span class="text-body-secondary">-</span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </c-card-body>

        <!-- Pagination -->
        @if (totalPages() > 1) {
          <c-card-footer
            class="d-flex justify-content-between align-items-center"
          >
            <small class="text-body-secondary">
              Showing {{ (currentPage() - 1) * pageSize() + 1 }} to
              {{ Math.min(currentPage() * pageSize(), totalAttendances()) }}
              of {{ totalAttendances() }} records
            </small>
            <div class="d-flex gap-2">
              <button
                cButton
                color="light"
                size="sm"
                (click)="previousPage()"
                [disabled]="currentPage() === 1 || loading()"
              >
                <svg cIcon name="cilChevronLeft"></svg>
                Previous
              </button>
              <button
                cButton
                color="light"
                size="sm"
                (click)="nextPage()"
                [disabled]="currentPage() === totalPages() || loading()"
              >
                Next
                <svg cIcon name="cilChevronRight"></svg>
              </button>
            </div>
          </c-card-footer>
        }
      </c-card>
    </c-col>
  </c-row>

  <!-- Empty State -->
  @if (filteredAttendances.length === 0 && !loading()) {
    <c-row>
      <c-col xs="12">
        <c-card>
          <c-card-body class="text-center py-5">
            <svg
              cIcon
              name="cilCalendar"
              size="3xl"
              class="text-body-secondary mb-3"
            ></svg>
            <h5 class="text-body-secondary">No attendance records found</h5>
            <p class="text-body-secondary">
              Try adjusting your search or filter criteria
            </p>
          </c-card-body>
        </c-card>
      </c-col>
    </c-row>
  }
}
