<!-- Header Section -->
<c-row class="mb-4">
  <c-col>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-1">Member-Trainer Assignments</h2>
        <p class="text-body-secondary mb-0">
          Assign members to trainers for personalized training
        </p>
      </div>
      <div class="d-flex gap-2">
        <button
          cButton
          color="light"
          (click)="refreshData()"
          [disabled]="loading()"
        >
          <svg cIcon name="cilReload" class="me-2"></svg>
          Refresh
        </button>
        <button
          cButton
          color="primary"
          (click)="openCreateModal()"
          [disabled]="loading()"
        >
          <svg cIcon name="cilUserFollow" class="me-2"></svg>
          New Assignment
        </button>
      </div>
    </div>
  </c-col>
</c-row>

<!-- Statistics Cards -->
@if (stats()) {
  <c-row class="mb-4">
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-lg-0">
      <c-card class="text-center">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Total Assignments</div>
          <h3 class="mb-0">{{ stats()!.totalAssignments }}</h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-lg-0">
      <c-card class="text-center border-success">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Active</div>
          <h3 class="mb-0 text-success">{{ stats()!.activeAssignments }}</h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-sm-0">
      <c-card class="text-center border-info">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Completed</div>
          <h3 class="mb-0 text-info">{{ stats()!.completedAssignments }}</h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3">
      <c-card class="text-center border-danger">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Cancelled</div>
          <h3 class="mb-0 text-danger">{{ stats()!.cancelledAssignments }}</h3>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}

<!-- Loading State -->
@if (loading() && assignments().length === 0) {
  <c-row>
    <c-col xs="12" class="text-center py-5">
      <c-spinner color="primary"></c-spinner>
      <p class="mt-3 text-body-secondary">Loading assignments...</p>
    </c-col>
  </c-row>
}

<!-- Error State -->
@if (error() && assignments().length === 0) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    </c-col>
  </c-row>
}

@if (!loading() || assignments().length > 0) {
  <!-- Filters and Search -->
  <c-row class="mb-4">
    <c-col xs="12" md="4" class="mb-3 mb-md-0">
      <div class="position-relative">
        <svg
          cIcon
          name="cilSearch"
          class="position-absolute"
          style="
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
          "
        ></svg>
        <input
          cFormControl
          type="text"
          placeholder="Search by member or trainer name..."
          [(ngModel)]="searchTerm"
          style="padding-left: 40px"
        />
      </div>
    </c-col>
    <c-col xs="12" md="3" class="mb-3 mb-md-0">
      <select
        cSelect
        [(ngModel)]="statusFilter"
        (ngModelChange)="applyFilters()"
      >
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </c-col>
    <c-col xs="12" md="3" class="mb-3 mb-md-0">
      <select
        cSelect
        [(ngModel)]="trainerFilter"
        (ngModelChange)="applyFilters()"
      >
        <option value="">All Trainers</option>
        @for (trainer of trainers(); track trainer._id) {
          <option [value]="trainer._id">
            {{ trainer.profile?.fullName || trainer.phoneNumber }}
          </option>
        }
      </select>
    </c-col>
    <c-col xs="12" md="2" class="d-flex justify-content-end align-items-center">
      <div class="btn-group" role="group">
        <button
          cButton
          [color]="viewMode() === 'grid' ? 'primary' : 'light'"
          (click)="viewMode.set('grid')"
          size="sm"
        >
          <svg cIcon name="cilGrid"></svg>
        </button>
        <button
          cButton
          [color]="viewMode() === 'list' ? 'primary' : 'light'"
          (click)="viewMode.set('list')"
          size="sm"
        >
          <svg cIcon name="cilList"></svg>
        </button>
      </div>
    </c-col>
  </c-row>

  <!-- Grid View -->
  @if (viewMode() === "grid") {
    <c-row>
      @for (assignment of filteredAssignments; track assignment._id) {
        <c-col xs="12" md="6" lg="4" class="mb-4">
          <c-card class="h-100 assignment-card">
            <c-card-body>
              <div
                class="d-flex justify-content-between align-items-start mb-3"
              >
                <c-badge [color]="getStatusColor(assignment.status)">
                  {{ assignment.status }}
                </c-badge>
                <c-dropdown alignment="end" variant="btn-group">
                  <button cButton color="ghost" size="sm" cDropdownToggle>
                    <svg cIcon name="cilOptions"></svg>
                  </button>
                  <ul cDropdownMenu>
                    <li>
                      <button
                        cDropdownItem
                        (click)="openDetailsModal(assignment)"
                      >
                        <svg cIcon name="cilInfo" class="me-2"></svg>
                        View Details
                      </button>
                    </li>
                    <li>
                      <button cDropdownItem (click)="openEditModal(assignment)">
                        <svg cIcon name="cilPencil" class="me-2"></svg>
                        Edit
                      </button>
                    </li>
                    <li><hr cDropdownDivider /></li>
                    <li>
                      <button
                        cDropdownItem
                        (click)="openDeleteModal(assignment)"
                        class="text-danger"
                      >
                        <svg cIcon name="cilTrash" class="me-2"></svg>
                        Delete
                      </button>
                    </li>
                  </ul>
                </c-dropdown>
              </div>

              <!-- Member Info -->
              <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                <c-avatar
                  [src]="assignment.member.profile?.profilePhoto"
                  color="primary"
                  size="md"
                  class="me-3"
                >
                  {{ getInitials(assignment.member.profile?.fullName) }}
                </c-avatar>
                <div class="flex-grow-1">
                  <div class="small text-body-secondary">Member</div>
                  <strong>{{
                    assignment.member.profile?.fullName ||
                      assignment.member.phoneNumber
                  }}</strong>
                  <div class="small text-body-secondary">
                    {{ assignment.member.phoneNumber }}
                  </div>
                </div>
              </div>

              <!-- Trainer Info -->
              <div class="d-flex align-items-center mb-3">
                <c-avatar
                  [src]="assignment.trainer.profile?.profilePhoto"
                  color="success"
                  size="md"
                  class="me-3"
                >
                  {{ getInitials(assignment.trainer.profile?.fullName) }}
                </c-avatar>
                <div class="flex-grow-1">
                  <div class="small text-body-secondary">Trainer</div>
                  <strong>{{
                    assignment.trainer.profile?.fullName ||
                      assignment.trainer.phoneNumber
                  }}</strong>
                  <div class="small text-body-secondary">
                    {{ assignment.trainer.phoneNumber }}
                  </div>
                </div>
              </div>

              <!-- Assignment Dates -->
              <div class="mt-3 pt-3 border-top">
                <div class="d-flex justify-content-between mb-2">
                  <small class="text-body-secondary">Assigned:</small>
                  <small>{{ formatDate(assignment.assignedDate) }}</small>
                </div>
                @if (assignment.endDate) {
                  <div class="d-flex justify-content-between">
                    <small class="text-body-secondary">End Date:</small>
                    <small>{{ formatDate(assignment.endDate) }}</small>
                  </div>
                }
              </div>
            </c-card-body>
          </c-card>
        </c-col>
      }
    </c-row>
  }

  <!-- List View -->
  @if (viewMode() === "list") {
    <c-row>
      <c-col xs="12">
        <c-card>
          <c-card-body class="p-0">
            <table cTable [hover]="true" class="mb-0">
              <thead>
                <tr>
                  <th scope="col">Member</th>
                  <th scope="col">Trainer</th>
                  <th scope="col">Assigned Date</th>
                  <th scope="col">End Date</th>
                  <th scope="col">Status</th>
                  <th scope="col" style="width: 100px">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (assignment of filteredAssignments; track assignment._id) {
                  <tr>
                    <td>
                      <div class="d-flex align-items-center">
                        <c-avatar
                          [src]="assignment.member.profile?.profilePhoto"
                          color="primary"
                          size="sm"
                          class="me-2"
                        >
                          {{ getInitials(assignment.member.profile?.fullName) }}
                        </c-avatar>
                        <div>
                          <strong>{{
                            assignment.member.profile?.fullName ||
                              assignment.member.phoneNumber
                          }}</strong>
                          <br />
                          <small class="text-body-secondary">{{
                            assignment.member.phoneNumber
                          }}</small>
                        </div>
                      </div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <c-avatar
                          [src]="assignment.trainer.profile?.profilePhoto"
                          color="success"
                          size="sm"
                          class="me-2"
                        >
                          {{
                            getInitials(assignment.trainer.profile?.fullName)
                          }}
                        </c-avatar>
                        <div>
                          <strong>{{
                            assignment.trainer.profile?.fullName ||
                              assignment.trainer.phoneNumber
                          }}</strong>
                          <br />
                          <small class="text-body-secondary">{{
                            assignment.trainer.phoneNumber
                          }}</small>
                        </div>
                      </div>
                    </td>
                    <td>{{ formatDate(assignment.assignedDate) }}</td>
                    <td>{{ formatDate(assignment.endDate) }}</td>
                    <td>
                      <c-badge [color]="getStatusColor(assignment.status)">
                        {{ assignment.status }}
                      </c-badge>
                    </td>
                    <td>
                      <button
                        cButton
                        color="ghost"
                        size="sm"
                        class="me-1"
                        (click)="openDetailsModal(assignment)"
                      >
                        <svg cIcon name="cilInfo"></svg>
                      </button>
                      <button
                        cButton
                        color="ghost"
                        size="sm"
                        class="me-1"
                        (click)="openEditModal(assignment)"
                      >
                        <svg cIcon name="cilPencil"></svg>
                      </button>
                      <button
                        cButton
                        color="ghost"
                        size="sm"
                        (click)="openDeleteModal(assignment)"
                      >
                        <svg cIcon name="cilTrash" class="text-danger"></svg>
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </c-card-body>
        </c-card>
      </c-col>
    </c-row>
  }

  <!-- Empty State -->
  @if (filteredAssignments.length === 0) {
    <c-row>
      <c-col xs="12">
        <c-card>
          <c-card-body class="text-center py-5">
            <svg
              cIcon
              name="cilUserFollow"
              size="3xl"
              class="text-body-secondary mb-3"
            ></svg>
            <h5 class="text-body-secondary">No assignments found</h5>
            <p class="text-body-secondary">
              Try adjusting your search or filters
            </p>
          </c-card-body>
        </c-card>
      </c-col>
    </c-row>
  }

  <!-- Pagination -->
  @if (totalPages() > 1) {
    <c-row class="mt-4">
      <c-col xs="12">
        <div class="d-flex justify-content-between align-items-center">
          <div class="text-body-secondary">
            Showing {{ (currentPage() - 1) * pageSize() + 1 }} to
            {{ Math.min(currentPage() * pageSize(), totalAssignments()) }} of
            {{ totalAssignments() }} assignments
          </div>
          <div class="btn-group">
            <button
              cButton
              color="light"
              size="sm"
              (click)="previousPage()"
              [disabled]="currentPage() === 1 || loading()"
            >
              <svg cIcon name="cilChevronLeft"></svg>
            </button>
            <button cButton color="light" size="sm" disabled>
              Page {{ currentPage() }} of {{ totalPages() }}
            </button>
            <button
              cButton
              color="light"
              size="sm"
              (click)="nextPage()"
              [disabled]="currentPage() === totalPages() || loading()"
            >
              <svg cIcon name="cilChevronRight"></svg>
            </button>
          </div>
        </div>
      </c-col>
    </c-row>
  }
}

<!-- Create/Edit Modal -->
<c-modal
  [visible]="modalVisible()"
  (visibleChange)="modalVisible.set($event)"
  size="lg"
>
  <c-modal-header>
    <h5 cModalTitle>
      {{ isEditMode() ? "Edit Assignment" : "Create New Assignment" }}
    </h5>
    <button cButtonClose (click)="closeModal()"></button>
  </c-modal-header>
  <c-modal-body>
    @if (error()) {
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    }
    @if (success()) {
      <c-alert color="success">
        <svg cIcon name="cilCheckCircle" class="me-2"></svg>
        {{ success() }}
      </c-alert>
    }

    <form>
      <c-row>
        <c-col xs="12" md="6">
          <div class="mb-3">
            <label cLabel for="member"
              >Member <span class="text-danger">*</span></label
            >
            <select
              cSelect
              id="member"
              [(ngModel)]="selectedMemberId"
              name="member"
              [disabled]="loading() || isEditMode()"
            >
              <option value="">Select Member</option>
              @for (member of members(); track member._id) {
                <option [value]="member._id">
                  {{ member.profile?.fullName || member.phoneNumber }} -
                  {{ member.phoneNumber }}
                </option>
              }
            </select>
            @if (isEditMode()) {
              <small class="text-body-secondary">
                Member cannot be changed after creation
              </small>
            }
          </div>
        </c-col>
        <c-col xs="12" md="6">
          <div class="mb-3">
            <label cLabel for="trainer"
              >Trainer <span class="text-danger">*</span></label
            >
            <select
              cSelect
              id="trainer"
              [(ngModel)]="selectedTrainerId"
              name="trainer"
              [disabled]="loading()"
            >
              <option value="">Select Trainer</option>
              @for (trainer of trainers(); track trainer._id) {
                <option [value]="trainer._id">
                  {{ trainer.profile?.fullName || trainer.phoneNumber }} -
                  {{ trainer.phoneNumber }}
                </option>
              }
            </select>
          </div>
        </c-col>
      </c-row>

      <c-row>
        @if (isEditMode()) {
          <c-col xs="12" md="6">
            <div class="mb-3">
              <label cLabel for="assignedDate">Assigned Date</label>
              <input
                cFormControl
                id="assignedDate"
                type="date"
                [(ngModel)]="currentAssignment.assignedDate"
                name="assignedDate"
                [disabled]="true"
              />
              <small class="text-body-secondary">
                Assigned date is set automatically
              </small>
            </div>
          </c-col>
        }
        @if (isEditMode() && currentAssignment.endDate) {
          <c-col xs="12" md="6">
            <div class="mb-3">
              <label cLabel for="endDate">End Date</label>
              <input
                cFormControl
                id="endDate"
                type="date"
                [(ngModel)]="currentAssignment.endDate"
                name="endDate"
                [disabled]="true"
              />
              <small class="text-body-secondary">
                End date is managed by the system
              </small>
            </div>
          </c-col>
        }
      </c-row>

      @if (isEditMode()) {
        <div class="mb-3">
          <label cLabel for="status"
            >Status <span class="text-danger">*</span></label
          >
          <select
            cSelect
            id="status"
            [(ngModel)]="currentAssignment.status"
            name="status"
            [disabled]="loading()"
          >
            <option value="Active">Active</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled">Cancelled</option>
          </select>
        </div>
      }

      <div class="mb-3">
        <label cLabel for="notes">Notes</label>
        <textarea
          cFormControl
          id="notes"
          rows="3"
          [(ngModel)]="currentAssignment.notes"
          name="notes"
          placeholder="Add any notes about this assignment..."
          [disabled]="loading()"
        ></textarea>
      </div>
    </form>
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="light" (click)="closeModal()" [disabled]="loading()">
      Cancel
    </button>
    <button
      cButton
      color="primary"
      (click)="saveAssignment()"
      [disabled]="!selectedMemberId || !selectedTrainerId || loading()"
    >
      @if (loading()) {
        <c-spinner size="sm" class="me-2"></c-spinner>
      } @else {
        <svg cIcon name="cilCheckCircle" class="me-2"></svg>
      }
      {{ isEditMode() ? "Update Assignment" : "Create Assignment" }}
    </button>
  </c-modal-footer>
</c-modal>

<!-- Details Modal -->
<c-modal
  [visible]="detailsModalVisible()"
  (visibleChange)="detailsModalVisible.set($event)"
  size="lg"
>
  <c-modal-header>
    <h5 cModalTitle>Assignment Details</h5>
    <button cButtonClose (click)="closeDetailsModal()"></button>
  </c-modal-header>
  <c-modal-body>
    @if (selectedAssignment) {
      <c-row class="mb-4">
        <c-col xs="12" md="6">
          <c-card class="h-100">
            <c-card-body>
              <h6 class="text-body-secondary mb-3">Member Information</h6>
              <div class="d-flex align-items-center mb-3">
                <c-avatar
                  [src]="selectedAssignment.member.profile?.profilePhoto"
                  color="primary"
                  size="lg"
                  class="me-3"
                >
                  {{ getInitials(selectedAssignment.member.profile?.fullName) }}
                </c-avatar>
                <div>
                  <strong class="d-block">{{
                    selectedAssignment.member.profile?.fullName ||
                      selectedAssignment.member.phoneNumber
                  }}</strong>
                  <small class="text-body-secondary">{{
                    selectedAssignment.member.phoneNumber
                  }}</small>
                </div>
              </div>
              @if (selectedAssignment.member.profile?.email) {
                <div class="mb-2">
                  <small class="text-body-secondary">Email:</small>
                  <div>{{ selectedAssignment.member.profile?.email }}</div>
                </div>
              }
            </c-card-body>
          </c-card>
        </c-col>
        <c-col xs="12" md="6">
          <c-card class="h-100">
            <c-card-body>
              <h6 class="text-body-secondary mb-3">Trainer Information</h6>
              <div class="d-flex align-items-center mb-3">
                <c-avatar
                  [src]="selectedAssignment.trainer.profile?.profilePhoto"
                  color="success"
                  size="lg"
                  class="me-3"
                >
                  {{
                    getInitials(selectedAssignment.trainer.profile?.fullName)
                  }}
                </c-avatar>
                <div>
                  <strong class="d-block">{{
                    selectedAssignment.trainer.profile?.fullName ||
                      selectedAssignment.trainer.phoneNumber
                  }}</strong>
                  <small class="text-body-secondary">{{
                    selectedAssignment.trainer.phoneNumber
                  }}</small>
                </div>
              </div>
              @if (selectedAssignment.trainer.profile?.email) {
                <div class="mb-2">
                  <small class="text-body-secondary">Email:</small>
                  <div>{{ selectedAssignment.trainer.profile?.email }}</div>
                </div>
              }
            </c-card-body>
          </c-card>
        </c-col>
      </c-row>

      <c-card>
        <c-card-body>
          <h6 class="text-body-secondary mb-3">Assignment Details</h6>
          <c-row>
            <c-col xs="12" md="6" class="mb-3">
              <small class="text-body-secondary">Status</small>
              <div>
                <c-badge [color]="getStatusColor(selectedAssignment.status)">
                  {{ selectedAssignment.status }}
                </c-badge>
              </div>
            </c-col>
            <c-col xs="12" md="6" class="mb-3">
              <small class="text-body-secondary">Assigned Date</small>
              <div>{{ formatDate(selectedAssignment.assignedDate) }}</div>
            </c-col>
            <c-col xs="12" md="6" class="mb-3">
              <small class="text-body-secondary">End Date</small>
              <div>{{ formatDate(selectedAssignment.endDate) }}</div>
            </c-col>
            @if (selectedAssignment.assignedBy) {
              <c-col xs="12" md="6" class="mb-3">
                <small class="text-body-secondary">Assigned By</small>
                <div>
                  {{
                    selectedAssignment.assignedBy.profile?.fullName ||
                      selectedAssignment.assignedBy.phoneNumber
                  }}
                </div>
              </c-col>
            }
            @if (selectedAssignment.notes) {
              <c-col xs="12">
                <small class="text-body-secondary">Notes</small>
                <div class="mt-1">{{ selectedAssignment.notes }}</div>
              </c-col>
            }
          </c-row>
        </c-card-body>
      </c-card>
    }
  </c-modal-body>
  <c-modal-footer>
    <button cButton color="light" (click)="closeDetailsModal()">Close</button>
    <button
      cButton
      color="primary"
      (click)="openEditModal(selectedAssignment!); closeDetailsModal()"
    >
      <svg cIcon name="cilPencil" class="me-2"></svg>
      Edit Assignment
    </button>
  </c-modal-footer>
</c-modal>

<!-- Delete Confirmation Modal -->
<c-modal
  [visible]="deleteModalVisible()"
  (visibleChange)="deleteModalVisible.set($event)"
>
  <c-modal-header>
    <h5 cModalTitle>Confirm Delete</h5>
    <button cButtonClose (click)="closeDeleteModal()"></button>
  </c-modal-header>
  <c-modal-body>
    @if (error()) {
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    }
    @if (success()) {
      <c-alert color="success">
        <svg cIcon name="cilCheckCircle" class="me-2"></svg>
        {{ success() }}
      </c-alert>
    }

    <div class="text-center py-3">
      <svg cIcon name="cilWarning" size="3xl" class="text-warning mb-3"></svg>
      <h5>Are you sure?</h5>
      <p class="text-body-secondary mb-0">
        You are about to delete the assignment between
        <strong>{{
          assignmentToDelete?.member?.profile?.fullName ||
            assignmentToDelete?.member?.phoneNumber
        }}</strong>
        and
        <strong>{{
          assignmentToDelete?.trainer?.profile?.fullName ||
            assignmentToDelete?.trainer?.phoneNumber
        }}</strong
        >. This action cannot be undone.
      </p>
    </div>
  </c-modal-body>
  <c-modal-footer>
    <button
      cButton
      color="light"
      (click)="closeDeleteModal()"
      [disabled]="loading()"
    >
      Cancel
    </button>
    <button
      cButton
      color="danger"
      (click)="deleteAssignment()"
      [disabled]="loading()"
    >
      @if (loading()) {
        <c-spinner size="sm" class="me-2"></c-spinner>
      } @else {
        <svg cIcon name="cilTrash" class="me-2"></svg>
      }
      Delete Assignment
    </button>
  </c-modal-footer>
</c-modal>
