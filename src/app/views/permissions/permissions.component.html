<c-row class="mb-4">
  <c-col xs="12" md="6">
    <div>
      <h2 class="mb-1">Permissions Management</h2>
      <p class="text-body-secondary mb-0">Assign permissions to roles</p>
    </div>
  </c-col>
  <c-col
    xs="12"
    md="6"
    class="d-flex align-items-center justify-content-md-end mt-3 mt-md-0"
  >
    <div class="d-flex align-items-center gap-3 w-100" style="max-width: 400px">
      <label cLabel class="mb-0 text-nowrap">Select Role:</label>
      <select
        cSelect
        [value]="selectedRoleId()"
        (change)="onRoleChange($event)"
        [disabled]="loading()"
        class="flex-grow-1"
      >
        @for (role of roles(); track role._id) {
          <option [value]="role._id">{{ formatRoleName(role.name) }}</option>
        }
      </select>
    </div>
  </c-col>
</c-row>

<!-- Loading State -->
@if (loading() && !rolePermissions()) {
  <c-row>
    <c-col xs="12" class="text-center py-5">
      <c-spinner color="primary"></c-spinner>
      <p class="mt-3 text-body-secondary">Loading permissions...</p>
    </c-col>
  </c-row>
}

<!-- Error State -->
@if (error()) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    </c-col>
  </c-row>
}

<!-- Success State -->
@if (success()) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="success"
        [dismissible]="true"
        (visibleChange)="!$event && success.set('')"
      >
        <svg cIcon name="cilCheckCircle" class="me-2"></svg>
        {{ success() }}
      </c-alert>
    </c-col>
  </c-row>
}

<!-- Permissions Table -->
@if (rolePermissions() && !loading()) {
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="p-0">
          <div class="table-responsive">
            <table cTable class="mb-0 permissions-table">
              <thead>
                <tr>
                  <th scope="col" class="module-column sticky-col">
                    <div class="d-flex align-items-center">
                      <svg cIcon name="cilLayers" class="me-2"></svg>
                      <strong>Module</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center permission-col">
                    <div class="d-flex flex-column align-items-center">
                      <svg cIcon name="cilPlus" class="mb-1 text-success"></svg>
                      <strong>Create</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center permission-col">
                    <div class="d-flex flex-column align-items-center">
                      <svg cIcon name="cilSearch" class="mb-1 text-info"></svg>
                      <strong>Read</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center permission-col">
                    <div class="d-flex flex-column align-items-center">
                      <svg
                        cIcon
                        name="cilPencil"
                        class="mb-1 text-warning"
                      ></svg>
                      <strong>Update</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center permission-col">
                    <div class="d-flex flex-column align-items-center">
                      <svg cIcon name="cilTrash" class="mb-1 text-danger"></svg>
                      <strong>Delete</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center permission-col">
                    <div class="d-flex flex-column align-items-center">
                      <svg
                        cIcon
                        name="cilCloudDownload"
                        class="mb-1 text-primary"
                      ></svg>
                      <strong>Export</strong>
                    </div>
                  </th>
                  <th scope="col" class="text-center action-column">
                    <strong>All</strong>
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (
                  module of rolePermissions()!.modules;
                  track module.moduleId
                ) {
                  <tr>
                    <td class="module-cell sticky-col">
                      <div class="d-flex align-items-center">
                        <svg
                          cIcon
                          [name]="module.moduleIcon || 'cilLayers'"
                          class="me-2 text-primary"
                        ></svg>
                        <strong>{{
                          formatModuleName(module.moduleName)
                        }}</strong>
                      </div>
                    </td>
                    @for (
                      action of [
                        "create",
                        "read",
                        "update",
                        "delete",
                        "export",
                      ];
                      track action
                    ) {
                      <td class="text-center">
                        @for (
                          permission of module.permissions;
                          track permission.permissionId
                        ) {
                          @if (permission.action.toLowerCase() === action) {
                            <div
                              class="form-check d-flex justify-content-center"
                            >
                              <input
                                class="form-check-input"
                                type="checkbox"
                                [id]="'perm-' + permission.permissionId"
                                [checked]="permission.isGranted"
                                (change)="
                                  onPermissionChange(permission, $event)
                                "
                              />
                            </div>
                          }
                        }
                      </td>
                    }
                    <td class="text-center">
                      <div class="form-check d-flex justify-content-center">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [id]="'module-all-' + module.moduleId"
                          [checked]="isModuleFullySelected(module)"
                          [indeterminate]="isModulePartiallySelected(module)"
                          (change)="selectAllForModule(module)"
                        />
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </c-card-body>
        <c-card-footer
          class="d-flex justify-content-between align-items-center"
        >
          <small class="text-body-secondary">
            Check the boxes to grant permissions to the selected role
          </small>
          <button
            cButton
            color="primary"
            (click)="savePermissions()"
            [disabled]="saving()"
          >
            @if (saving()) {
              <c-spinner size="sm" class="me-2"></c-spinner>
            } @else {
              <svg cIcon name="cilSave" class="me-2"></svg>
            }
            Save Permissions
          </button>
        </c-card-footer>
      </c-card>
    </c-col>
  </c-row>
}

@if (!loading() && roles().length === 0) {
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="text-center py-5">
          <svg
            cIcon
            name="cilShieldAlt"
            size="3xl"
            class="text-body-secondary mb-3"
          ></svg>
          <h5 class="text-body-secondary">No roles found</h5>
          <p class="text-body-secondary">
            Create roles first to manage permissions
          </p>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}
