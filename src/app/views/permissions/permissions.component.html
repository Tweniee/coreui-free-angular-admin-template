<c-row class="mb-4">
  <c-col xs="12" md="6">
    <div>
      <h2 class="mb-1">Permissions Management</h2>
      <p class="text-body-secondary mb-0">Assign permissions to roles</p>
    </div>
  </c-col>
  <c-col
    xs="12"
    md="6"
    class="d-flex align-items-center justify-content-md-end mt-3 mt-md-0"
  >
    <div class="d-flex align-items-center gap-3 w-100" style="max-width: 400px">
      <label cLabel class="mb-0 text-nowrap">Select Role:</label>
      <select
        cSelect
        [value]="selectedRole()?._id || ''"
        (change)="onRoleChange($event)"
        [disabled]="loading()"
        class="flex-grow-1"
      >
        @for (role of roles(); track role._id) {
          <option [value]="role._id">{{ formatRoleName(role.name) }}</option>
        }
      </select>
    </div>
  </c-col>
</c-row>

<!-- Loading State -->
@if (loading() && roles().length === 0) {
  <c-row>
    <c-col xs="12" class="text-center py-5">
      <c-spinner color="primary"></c-spinner>
      <p class="mt-3 text-body-secondary">Loading roles...</p>
    </c-col>
  </c-row>
}

<!-- Error State -->
@if (error()) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    </c-col>
  </c-row>
}

<!-- Success State -->
@if (success()) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="success"
        [dismissible]="true"
        (visibleChange)="!$event && success.set('')"
      >
        <svg cIcon name="cilCheckCircle" class="me-2"></svg>
        {{ success() }}
      </c-alert>
    </c-col>
  </c-row>
}

<!-- Permissions Table -->
@if (selectedRole() && !loading()) {
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="p-0">
          <div class="table-responsive">
            <table cTable class="mb-0 permissions-table">
              <thead>
                <tr>
                  <th scope="col" class="module-column">
                    <div class="d-flex align-items-center">
                      <svg cIcon name="cilLayers" class="me-2"></svg>
                      <strong>Module</strong>
                    </div>
                  </th>
                  @for (operation of crudOperations; track operation.key) {
                    <th scope="col" class="text-center crud-column">
                      <div class="d-flex flex-column align-items-center">
                        <svg cIcon [name]="operation.icon" class="mb-1"></svg>
                        <strong>{{ operation.name }}</strong>
                      </div>
                    </th>
                  }
                  <th scope="col" class="text-center action-column">
                    <strong>All</strong>
                  </th>
                </tr>
              </thead>
              <tbody>
                @for (module of modules; track module.key) {
                  <tr>
                    <td class="module-cell">
                      <div class="d-flex align-items-center">
                        <svg
                          cIcon
                          [name]="module.icon"
                          class="me-2 text-primary"
                        ></svg>
                        <strong>{{ module.name }}</strong>
                      </div>
                    </td>
                    @for (operation of crudOperations; track operation.key) {
                      <td class="text-center">
                        <div class="form-check d-flex justify-content-center">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            [id]="'perm-' + module.key + '-' + operation.key"
                            [checked]="hasPermission(module.key, operation.key)"
                            (change)="
                              togglePermission(module.key, operation.key)
                            "
                          />
                        </div>
                      </td>
                    }
                    <td class="text-center">
                      <div class="form-check d-flex justify-content-center">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          [id]="'module-all-' + module.key"
                          [checked]="isModuleFullySelected(module.key)"
                          [indeterminate]="
                            isModulePartiallySelected(module.key)
                          "
                          (change)="selectAllForModule(module.key)"
                        />
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </c-card-body>
        <c-card-footer class="d-flex justify-content-end">
          <button
            cButton
            color="primary"
            (click)="savePermissions()"
            [disabled]="saving()"
          >
            @if (saving()) {
              <c-spinner size="sm" class="me-2"></c-spinner>
            } @else {
              <svg cIcon name="cilSave" class="me-2"></svg>
            }
            Save Permissions
          </button>
        </c-card-footer>
      </c-card>
    </c-col>
  </c-row>
}

@if (!loading() && roles().length === 0) {
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="text-center py-5">
          <svg
            cIcon
            name="cilShieldAlt"
            size="3xl"
            class="text-body-secondary mb-3"
          ></svg>
          <h5 class="text-body-secondary">No roles found</h5>
          <p class="text-body-secondary">
            Create roles first to manage permissions
          </p>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}
