<c-row class="mb-4">
  <c-col>
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h2 class="mb-1">Payments</h2>
        <p class="text-body-secondary mb-0">View all payment transactions</p>
      </div>
      <button
        cButton
        color="primary"
        variant="outline"
        (click)="refreshData()"
        [disabled]="loading()"
        title="Refresh payments"
      >
        @if (loading()) {
          <c-spinner size="sm"></c-spinner>
        } @else {
          <svg cIcon name="cilReload"></svg>
        }
      </button>
    </div>
  </c-col>
</c-row>

<!-- Stats Cards -->
@if (stats()) {
  <c-row class="mb-4">
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-lg-0">
      <c-card class="text-center">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Total Payments</div>
          <h3 class="mb-0">{{ stats()!.totalPayments }}</h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-lg-0">
      <c-card class="text-center">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Total Amount</div>
          <h3 class="mb-0 text-success">
            ₹{{ stats()!.totalAmount | number: "1.2-2" }}
          </h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3" class="mb-3 mb-sm-0">
      <c-card class="text-center">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Pending Amount</div>
          <h3 class="mb-0 text-warning">
            ₹{{ stats()!.pendingAmount | number: "1.2-2" }}
          </h3>
        </c-card-body>
      </c-card>
    </c-col>
    <c-col xs="12" sm="6" lg="3">
      <c-card class="text-center">
        <c-card-body>
          <div class="text-body-secondary small mb-1">Paid</div>
          <h3 class="mb-0 text-info">
            {{ stats()!.paymentsByStatus["paid"] || 0 }}
          </h3>
        </c-card-body>
      </c-card>
    </c-col>
  </c-row>
}

<!-- Loading State -->
@if (loading() && payments().length === 0) {
  <c-row>
    <c-col xs="12" class="text-center py-5">
      <c-spinner color="primary"></c-spinner>
      <p class="mt-3 text-body-secondary">Loading payments...</p>
    </c-col>
  </c-row>
}

<!-- Error State -->
@if (error() && payments().length === 0) {
  <c-row>
    <c-col xs="12">
      <c-alert
        color="danger"
        [dismissible]="true"
        (visibleChange)="!$event && error.set('')"
      >
        <svg cIcon name="cilWarning" class="me-2"></svg>
        {{ error() }}
      </c-alert>
    </c-col>
  </c-row>
}

@if (!loading() || payments().length > 0) {
  <!-- Filters -->
  <c-row class="mb-4">
    <c-col xs="12" md="4">
      <label cLabel for="statusFilter" class="mb-2">Status</label>
      <select
        cSelect
        id="statusFilter"
        [(ngModel)]="selectedStatus"
        (ngModelChange)="onFilterChange()"
      >
        <option value="">All Status</option>
        @for (status of statusOptions; track status) {
          <option [value]="status">{{ status }}</option>
        }
      </select>
    </c-col>
    <c-col xs="12" md="4">
      <label cLabel for="paymentModeFilter" class="mb-2">Payment Mode</label>
      <select
        cSelect
        id="paymentModeFilter"
        [(ngModel)]="selectedPaymentMode"
        (ngModelChange)="onFilterChange()"
      >
        <option value="">All Modes</option>
        @for (mode of paymentModeOptions; track mode) {
          <option [value]="mode">{{ mode }}</option>
        }
      </select>
    </c-col>
    <c-col xs="12" md="4" class="d-flex align-items-end">
      <button
        cButton
        color="light"
        (click)="clearFilters()"
        [disabled]="!selectedStatus() && !selectedPaymentMode()"
        class="w-100"
      >
        <svg cIcon name="cilReload" class="me-2"></svg>
        Clear Filters
      </button>
    </c-col>
  </c-row>

  <!-- Payments Table -->
  <c-row>
    <c-col xs="12">
      <c-card>
        <c-card-body class="p-0">
          <div class="table-responsive">
            <table cTable [hover]="true" class="mb-0">
              <thead>
                <tr>
                  <th scope="col">Transaction ID</th>
                  <th scope="col">User</th>
                  <th scope="col">Amount</th>
                  <th scope="col">Payment Mode</th>
                  <th scope="col">Status</th>
                  <th scope="col">Payment Date</th>
                  <th scope="col" style="width: 100px">Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (payment of payments(); track payment._id) {
                  <tr>
                    <td>
                      <code class="small">{{
                        payment.transactionId || payment._id.slice(-8)
                      }}</code>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <svg
                          cIcon
                          name="cilUser"
                          class="me-2 text-primary"
                        ></svg>
                        <span>{{ payment.userName || "Unknown User" }}</span>
                      </div>
                    </td>
                    <td>
                      <strong class="text-success"
                        >₹{{ payment.amount | number: "1.2-2" }}</strong
                      >
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        <svg
                          cIcon
                          [name]="getPaymentModeIcon(payment.paymentMode)"
                          class="me-2"
                        ></svg>
                        <span class="text-capitalize">{{
                          payment.paymentMode
                        }}</span>
                      </div>
                    </td>
                    <td>
                      <c-badge
                        [color]="getStatusColor(payment.status)"
                        class="text-capitalize"
                      >
                        {{ payment.status }}
                      </c-badge>
                    </td>
                    <td>
                      <span class="text-body-secondary">
                        {{ payment.paymentDate | date: "MMM d, yyyy h:mm a" }}
                      </span>
                    </td>
                    <td>
                      <button
                        cButton
                        color="ghost"
                        size="sm"
                        (click)="openDetailsModal(payment)"
                        title="View Details"
                      >
                        <svg cIcon name="cilInfo"></svg>
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </c-card-body>

        <!-- Pagination -->
        @if (totalPages() > 1) {
          <c-card-footer
            class="d-flex justify-content-between align-items-center"
          >
            <small class="text-body-secondary">
              Showing {{ (currentPage() - 1) * pageSize() + 1 }} to
              {{ Math.min(currentPage() * pageSize(), totalPayments()) }} of
              {{ totalPayments() }} payments
            </small>
            <div class="d-flex gap-2">
              <button
                cButton
                color="light"
                size="sm"
                (click)="previousPage()"
                [disabled]="currentPage() === 1 || loading()"
              >
                <svg cIcon name="cilChevronLeft"></svg>
                Previous
              </button>
              <button
                cButton
                color="light"
                size="sm"
                (click)="nextPage()"
                [disabled]="currentPage() === totalPages() || loading()"
              >
                Next
                <svg cIcon name="cilChevronRight"></svg>
              </button>
            </div>
          </c-card-footer>
        }
      </c-card>
    </c-col>
  </c-row>

  @if (payments().length === 0 && !loading()) {
    <c-row>
      <c-col xs="12">
        <c-card>
          <c-card-body class="text-center py-5">
            <svg
              cIcon
              name="cilWallet"
              size="3xl"
              class="text-body-secondary mb-3"
            ></svg>
            <h5 class="text-body-secondary">No payments found</h5>
            <p class="text-body-secondary">
              @if (selectedStatus() || selectedPaymentMode()) {
                Try adjusting your filters
              } @else {
                There are no payment transactions to display
              }
            </p>
          </c-card-body>
        </c-card>
      </c-col>
    </c-row>
  }

  <!-- Payment Details Modal -->
  <c-modal
    [visible]="detailsModalVisible()"
    (visibleChange)="detailsModalVisible.set($event)"
    size="lg"
  >
    <c-modal-header>
      <h5 cModalTitle>Payment Details</h5>
      <button cButtonClose (click)="closeDetailsModal()"></button>
    </c-modal-header>
    <c-modal-body>
      @if (selectedPayment()) {
        <c-row class="mb-3">
          <c-col xs="12">
            <div
              class="d-flex justify-content-between align-items-center p-3 bg-light rounded"
            >
              <div>
                <small class="text-body-secondary d-block">Amount</small>
                <h3 class="mb-0 text-success">
                  ₹{{ selectedPayment()!.amount | number: "1.2-2" }}
                </h3>
              </div>
              <c-badge
                [color]="getStatusColor(selectedPayment()!.status)"
                class="text-capitalize fs-6 px-3 py-2"
              >
                {{ selectedPayment()!.status }}
              </c-badge>
            </div>
          </c-col>
        </c-row>

        <c-row class="g-3">
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-primary ps-3">
              <small class="text-body-secondary d-block mb-1"
                >Transaction ID</small
              >
              <code>{{
                selectedPayment()!.transactionId || selectedPayment()!._id
              }}</code>
            </div>
          </c-col>
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-info ps-3">
              <small class="text-body-secondary d-block mb-1">User</small>
              <strong>{{
                selectedPayment()!.userName || "Unknown User"
              }}</strong>
            </div>
          </c-col>
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-success ps-3">
              <small class="text-body-secondary d-block mb-1"
                >Payment Mode</small
              >
              <div class="d-flex align-items-center">
                <svg
                  cIcon
                  [name]="getPaymentModeIcon(selectedPayment()!.paymentMode)"
                  class="me-2"
                ></svg>
                <span class="text-capitalize">{{
                  selectedPayment()!.paymentMode
                }}</span>
              </div>
            </div>
          </c-col>
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-warning ps-3">
              <small class="text-body-secondary d-block mb-1"
                >Payment Date</small
              >
              <strong>{{
                selectedPayment()!.paymentDate | date: "MMM d, yyyy h:mm a"
              }}</strong>
            </div>
          </c-col>
          @if (selectedPayment()!.description) {
            <c-col xs="12">
              <div class="border-start border-3 border-secondary ps-3">
                <small class="text-body-secondary d-block mb-1"
                  >Description</small
                >
                <p class="mb-0">{{ selectedPayment()!.description }}</p>
              </div>
            </c-col>
          }
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-secondary ps-3">
              <small class="text-body-secondary d-block mb-1">Created At</small>
              <span>{{
                selectedPayment()!.createdAt | date: "MMM d, yyyy h:mm a"
              }}</span>
            </div>
          </c-col>
          <c-col xs="12" md="6">
            <div class="border-start border-3 border-secondary ps-3">
              <small class="text-body-secondary d-block mb-1"
                >Last Updated</small
              >
              <span>{{
                selectedPayment()!.updatedAt | date: "MMM d, yyyy h:mm a"
              }}</span>
            </div>
          </c-col>
        </c-row>
      }
    </c-modal-body>
    <c-modal-footer>
      <button cButton color="light" (click)="closeDetailsModal()">Close</button>
    </c-modal-footer>
  </c-modal>
}
